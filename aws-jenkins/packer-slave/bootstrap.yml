---
- name: Prepare dynamic Jenkins slave
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Install yum utils
      yum:
        name:
          - java-1.8.0-openjdk
          - docker
          - device-mapper-persistent-data
          - lvm2

    - name: Download nvm
      get_url:
        url: https://raw.githubusercontent.com/creationix/nvm/v0.33.2/install.sh
        dest: /home/ec2-user/install.sh

    - name: Install nvm
      shell: >
        bash /home/ec2-user/install.sh
      environment:
        - NVM_DIR: /usr/bin

    - name: Move binary to path
      copy:
        src: /usr/bin/nvm.sh
        dest: /usr/bin/nvm

    - name: Install Node.js
      become: true
      shell: >
        nvm install node

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes
      become: yes